name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      API_KEY: ${{ secrets.API_KEY }}
      API_SECRET: ${{ secrets.API_SECRET }}
      CLIENT_ID: ${{ secrets.CLIENT_ID }}
      TEST_EMAIL: ${{ secrets.TEST_EMAIL }}
      AWS_CONNECTION_IMAGE: ${{ secrets.AWS_CONNECTION_IMAGE }}
      AWS_CONNECTION_VIDEO: ${{ secrets.AWS_CONNECTION_VIDEO }}
      GCS_CONNECTION_IMAGE: ${{ secrets.GCS_CONNECTION_IMAGE }}
      GCS_CONNECTION_VIDEO: ${{ secrets.GCS_CONNECTION_VIDEO }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run linting
        run: |
          if grep -q "^lint:" Makefile; then
            make lint
          else
            pip install ruff
            ruff check .
          fi

      - name: Run formatting check
        run: |
          if grep -q "^format:" Makefile; then
            make format
          else
            pip install black
            black --check .
          fi

      - name: Run unit tests
        run: make test

      - name: Run integration tests
        run: make integration-test
